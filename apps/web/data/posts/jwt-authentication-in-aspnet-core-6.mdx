---
title: "Cómo implementar JWT en ASP.NET Core 6"
summary: "En este..."
coverImage: "/assets/images/nextjs-realtime-comments/cover-image.jpg"
createdAt: "2023-03-29 21:35:00"
tags:
  - name: "JWT"
    slug: "jwt"
  - name: "ASP.NET"
    slug: "aspnet"
  - name: "Web API"
    slug: "webapi"
relateds:
---

JWT (JSON Web Token) es una forma segura y eficiente de transmitir información
entre diferentes sistemas en forma de objetos JSON. En el contexto de las API web,
JWT se utiliza a menudo como un mecanismo de autenticación y autorización,
permitiendo a los usuarios autenticarse en una aplicación web y luego autorizar las
solicitudes de la API en función de su nivel de acceso.

En este articulo aprenderas a implementar JWT en una aplicación Web API utilizando
ASP.NET Core 6. Para asegurar una Web API usando la autenticación JWT,
seguiremos estos pasos:

### #1 Cree un proyecto ASP.NET Core Web API en Visual Studio 2022.

1. Inicie el IDE de Visual Studio 2022.
2. Haga clic en "Crear nuevo proyecto".
3. En la ventana "Crear nuevo proyecto", seleccione "ASP.NET Core Web API".
4. Haga clic en Siguiente.
5. En la ventana "Configura tu nuevo proyecto", especifica el nombre y la ubicación del nuevo proyecto.
6. Opcionalmente, marque la casilla de verificación "Colocar la solución y el proyecto en el mismo directorio", según sus preferencias.
7. Haga clic en Siguiente.
8. En la ventana "Información adicional" que se muestra a continuación, dejamos todo predeterminado asegurandonos que la casila de "Enable Docker" no esté marcada.
9. Haz clic en Crear.

### #2 Instale el paquete JwtBearer NuGet

Ahora agregue el paquete `Microsoft.AspNetCore.Authentication.JwtBearer` a su proyecto en su versión 6.0.15.
Para hacer esto, seleccione _Tools > NuGet Package Manager > Manage NuGet Packages for Solutions_. En la
ventana del Administrator de paquetes NuGet, busque el paquete `Microsoft.AspNetCore.Authentication.JwtBearer` e instálelo.

Tambien puede hacer la instalación desde la consola ejecutando el siguiente comando:

Package Manager

```bash
NuGet\Install-Package Microsoft.AspNetCore.Authentication.JwtBearer -Version 6.0.15
```

.NET CLI

```bash
dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer --version 6.0.15
```

### #3 Especifique la clave secreta en el archivo appsettings.json

A continuación, cree una sección en el archivo `appsettings.json` para la información del emisor,
la audiencia y la clave. Esta infirmación se utilizara para crear un **JSON Web Token**.

Agregue la siguiente información en el archivo `appsettings.json`:

```json
// appsettings.json

{
  "Jwt": {
    "Issuer": "https://alckor.dev/",
    "Audience": "https://alckor.dev/",
    "Key": "This is a sample secret key"
  }
}
```

<CustomAlert
  type="info"
  variant="left-accent"
  title="Nota:"
  message="JWT utiliza una clave secreta para generar y validar los tokens. Es importante mantener esta clave segura y no compartirla con terceros, ya que cualquier persona que tenga acceso a la clave podría generar tokens válidos y acceder a recursos protegidos. Se recomienda almacenar la clave en un lugar seguro, como variables de entorno o en un servicio de almacenamiento de claves. Además, se debe evitar el uso de claves predeterminadas o fáciles de adivinar, ya que esto aumenta el riesgo de que la clave sea comprometida."
/>

### #3 Especifique la configuración de autenticación en el archivo Program.cs

El método AddAuthenication en el archivo `Program.cs`
se usa para configurar la autenticación JWT en el momento en que se inicia la aplicación.
Especifica el esquema de autenticación como `JwtBearer`. Además, la llamada al método
`AddJwtBearer` ayuda a configurar los parámetros del token.

Los valores de Emisor, Audiencia y Clave se leen del archivo de configuración `appsettings.json`.
La instancia de `TokenValidationParameters` se utiliza para indicar si la información del emisor,
la audiencia, la clave y la vida útil debe validarse o no.

Nos dirigimos al archivo `Program.cs` y agregamos la siguiente configuración:

```csharp
// Program.cs

using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.IdentityModel.Tokens;
using System.Text;

// ...

// Configure JWT
builder.Services.AddAuthentication(x =>
{
    x.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    x.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
    x.DefaultScheme = JwtBearerDefaults.AuthenticationScheme;
}).AddJwtBearer(x =>
{
    x.TokenValidationParameters = new TokenValidationParameters
    {
        ValidIssuer = builder.Configuration["Jwt:Issuer"],
        ValidAudience = builder.Configuration["Jwt:Audience"],
        IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(builder.Configuration["Jwt:Key"])),
        ValidateIssuer = true,
        ValidateAudience = true,
        ValidateLifetime = true,
        ValidateIssuerSigningKey = true,
    };
});

// ...
```

Para agregar el sericio de autoriación a su apciación, tambien debe incluir el siguiente código:

```csharp
// Program.cs
// ...

builder.Services.AddAuthorization();

// ...
```

También se debe inclur los siguientes metodos para habilitar la capacidad de autenticación y autorización.

```csharp
// Program.cs
// ...

app.UseAuthentication();
app.UseAuthorization();

// ...
```

### #4 Cree un modelo para el usuario en ASP.NET Core 6

Cree una clase `Entities/User.cs` para almacenar las credenciales del inicio de sesión.

```csharp
// Entities/User.cs

namespace ApiJWT.Entities
{
    public class User
    {
        public string Username { get; set; } = null!;
        public string Password { get; set; } = null!;
    }
}

```

### #5 Cree los endpoints

Para probar el funcionamiento de nuestra aplicación vamos a crear los siguientes controladores:

**AuthController**, se encargará de crear y retornar el JWT:

```csharp
// Controllers/AuthController.cs

using ApiJWT.Entities;
using Microsoft.AspNetCore.Mvc;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

namespace ApiJWT.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class AuthController : ControllerBase
    {
        private readonly IConfiguration _config;

        public AuthController(IConfiguration config)
        {
            _config = config;
        }

        [HttpPost]
        public ActionResult PostAuth(User user)
        {
            if (user.Username == "alckordev" && user.Password == "zxcvbnm")
            {
                var issuer = _config["Jwt:Issuer"];
                var audience = _config["Jwt:Audience"];
                var key = Encoding.UTF8.GetBytes(_config["Jwt:Key"]);

                var tokenDescriptor = new SecurityTokenDescriptor
                {
                    Subject = new ClaimsIdentity(new[]
                    {
                        new Claim("Id", Guid.NewGuid().ToString()),
                        new Claim(JwtRegisteredClaimNames.Sub, user.Username),
                        new Claim(JwtRegisteredClaimNames.Email, user.Username),
                        new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString())
                    }),
                    Expires = DateTime.UtcNow.AddMinutes(5),
                    Issuer = issuer,
                    Audience = audience,
                    SigningCredentials = new SigningCredentials(
                        new SymmetricSecurityKey(key),
                        SecurityAlgorithms.HmacSha256Signature
                    )
                };

                var tokenHandler = new JwtSecurityTokenHandler();
                var jwtToken = tokenHandler.CreateToken(tokenDescriptor);
                var stringToken = tokenHandler.WriteToken(jwtToken);

                return Ok(new
                {
                    token = stringToken
                });
            }

            return Unauthorized();
        }
    }
}
```

![Resultado del endpoint de autenticación](/assets/images/jwt-authentication-in-aspnet-core-6/jwt-aspnet-core-4.png)
_Imagen 1. HTTP POST retorna el token en la respuesta._

Luego, creamos un controlador llamado **PublicController**, con el siguiente contenido:

```csharp
// Controllers/PublicController.cs

using Microsoft.AspNetCore.Mvc;

namespace ApiJWT.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class PublicController : ControllerBase
    {
        [HttpGet("GetWelcomeMessage")]
        public ActionResult GetWelcomeMessage()
        {
            return Ok(new
            {
                Title = "Welcome!",
                message = "I'm a public endpoint."
            });
        }
    }
}
```

No hay magia aquí, este es un simple controldor que no necesita de autorización para acceder en el.
Aquí se pueden presentar algunas endpoints públicos, que no, necesiten de una autenticación previa.

![Resultado del endpoint público](/assets/images/jwt-authentication-in-aspnet-core-6/jwt-aspnet-core-5.png)
_Imagen 2. HTTP GET retorna el mensaje en la respuesta._

Por último, la verdadera magina empieza aquí, creamos un controlador llamado `PrivateController`,
con el siguiente contenido:

```csharp
// Controllers/PrivateController.cs

using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace ApiJWT.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    [Authorize]
    public class PrivateController : ControllerBase
    {
        [HttpGet("GetWelcomeMessage")]
        public ActionResult GetWelcomeMessage()
        {
            return Ok(new
            {
                Title = "Welcome!",
                message = "I'm a private endpoint."
            });
        }
    }
}

```

Como podemos observar la unica diferencia con el controlador público es que, a nuestros controlador
privado le hemos agregado una etiqueta `[Authorize]`, la cual indica que el recurso controlado
por el controlador está protegido y solo es accesible para usuarios autenticados y autorizados.

Si no enviamos el token en la cabecera nos retornara un status code 401, como se muestra en la imagen:

![Resultado del endpoint private 401](/assets/images/jwt-authentication-in-aspnet-core-6/jwt-aspnet-core-6.png)
_Imagen 3. HTTP GET retorna un status code 401 porque la solicitud no está autenticada._

Necesitamos enviar el token en la cabecera para poder acceder al contenido protegido, como se muestra en
la imagen:

![Resultado del endpoint private 200](/assets/images/jwt-authentication-in-aspnet-core-6/jwt-aspnet-core-7.png)
_Imagen 4. HTTP GET retorna el mensaje correctamente porque la solicita fue autorizada por el token._
